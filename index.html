<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ðŸ“œ Trip Ledger - Bankin' Style</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600&display=swap');
    
    :root { 
      --bg-cream: #f1ede4; 
      --main-brown: #6d5d51; 
      --accent-tan: #d9cfc1;
      --soft-white: rgba(255, 255, 255, 0.9);
    }

    body { 
      background-color: var(--bg-cream); 
      font-family: 'Inter', sans-serif; 
      color: var(--main-brown); 
      -webkit-font-smoothing: antialiased; 
      scroll-behavior: smooth; 
    }

    .serif { font-family: 'Playfair Display', serif; }
    
    .app-card { 
      background: var(--soft-white); 
      border-radius: 28px; 
      box-shadow: 0 4px 20px rgba(109, 93, 81, 0.08); 
      border: 1px solid rgba(255, 255, 255, 0.5);
    }

    .settled { opacity: 0.3; text-decoration: line-through; filter: grayscale(1); }
    .custom-scroll::-webkit-scrollbar { height: 0px; width: 0px; } 

    input[type="text"], input[type="number"], select { 
      background: #ffffff; 
      outline: none; 
      border-radius: 20px;
      font-size: 16px !important; 
      padding: 14px 18px;
      width: 100%;
      border: 1px solid transparent;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
      text-align: center;
      text-align-last: center;
    }

    input[type="date"] {
      background: #ffffff;
      border-radius: 16px;
      padding: 10px 8px;
      font-size: 13px !important;
      color: var(--main-brown);
      width: 100%;
      border: none;
      -webkit-appearance: none;
      display: block;
      box-sizing: border-box;
    }
    
    #tripName { background: transparent; border: none; font-size: 28px !important; padding: 0; box-shadow: none; text-align: left; }
    
    .btn-primary { 
      background-color: var(--main-brown); 
      color: white; 
      padding: 16px; 
      border-radius: 20px; 
      font-size: 14px; 
      font-weight: bold; 
      width: 100%; 
      transition: opacity 0.2s;
    }

    .trip-tab { 
      background: var(--accent-tan); 
      padding: 10px 24px; 
      border-radius: 20px; 
      font-size: 13px; 
      font-weight: 600; 
      white-space: nowrap; 
      cursor: pointer; 
      color: #8c8279;
      opacity: 0.6;
    }
    .trip-tab.active { 
      background: white; 
      color: var(--main-brown); 
      opacity: 1;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    input[type="checkbox"] { width: 22px; height: 22px; accent-color: var(--main-brown); border-radius: 8px; }

    .jump-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 56px;
      height: 56px;
      background: var(--main-brown);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 24px rgba(109, 93, 81, 0.3);
      z-index: 99;
      font-size: 24px;
    }

    .pool-box {
      background: #dfd8cf;
      border-radius: 28px;
    }
  </style>
</head>
<body class="p-0">

  <div class="jump-btn" onclick="document.getElementById('settlementArea').scrollIntoView()">â†“</div>

  <main class="max-w-md mx-auto min-h-screen flex flex-col">
    <div class="flex overflow-x-auto px-4 py-4 gap-2 custom-scroll">
        <div id="tabContainer" class="flex gap-2"></div>
        <button onclick="addNewTrip()" class="w-10 h-10 flex-shrink-0 bg-white/50 rounded-full font-bold opacity-50">+</button>
    </div>

    <div class="px-6 py-2 space-y-4">
      <input id="tripName" type="text" placeholder="Trip Name..." oninput="saveAll()" class="serif font-bold">
      
      <div class="flex gap-3 bg-white/40 p-3 rounded-[24px] items-end">
          <div class="flex-1 min-w-0">
            <p class="text-[9px] font-bold opacity-40 mb-1 ml-3 uppercase tracking-tighter">Start Date</p>
            <input type="date" id="startDate" onchange="saveAll()">
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-[9px] font-bold opacity-40 mb-1 ml-3 uppercase tracking-tighter">End Date</p>
            <input type="date" id="endDate" onchange="saveAll()">
          </div>
      </div>

      <div class="app-card p-4 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="text-[10px] font-bold uppercase opacity-50">1 HKD =</span>
            <select id="targetCurr" onchange="handleCurrChange()" class="!w-20 !p-1 !rounded-lg !text-xs font-bold bg-transparent">
                <option value="JPY">JPY</option><option value="KRW">KRW</option>
                <option value="USD">USD</option><option value="TWD">TWD</option>
            </select>
          </div>
          <input id="currentRateVal" type="number" step="0.001" onchange="saveAll()" class="!w-24 !p-1 !bg-transparent text-right font-bold text-lg">
          <button onclick="fetchLiveRate()" class="text-[9px] bg-white px-3 py-2 rounded-full font-bold shadow-sm">Live</button>
      </div>
    </div>

    <div class="flex-1 p-6 space-y-8">
        <div class="flex justify-between items-center bg-white/30 p-2 rounded-full">
            <div id="memberList" class="flex flex-wrap gap-2 px-2"></div>
            <button onclick="addMember()" class="w-10 h-10 bg-white rounded-full text-lg shadow-sm">+</button>
        </div>

        <section class="pool-box p-6 shadow-inner">
            <div class="flex justify-between items-start mb-4">
                <div>
                  <p class="text-[10px] font-bold opacity-60 uppercase tracking-widest mb-1">Common Pool (<span class="target-curr-label">---</span>)</p>
                  <div id="commonPoolInfo" class="text-4xl font-bold tracking-tighter">0</div>
                </div>
                <button onclick="openDepositModal()" class="bg-white px-4 py-2 rounded-xl text-[10px] font-bold shadow-sm">TOP UP</button>
            </div>
            <div id="depositList" class="space-y-2"></div>
        </section>

        <section class="space-y-3">
            <div class="flex justify-between items-center">
                <p class="serif text-xl font-bold">Pre-Trip</p>
                <button onclick="openModal('PRE')" class="text-[10px] font-bold bg-white/80 px-4 py-2 rounded-full">+ Add</button>
            </div>
            <div id="preTripContainer" class="space-y-3"></div>
        </section>

        <div id="timelineContainer" class="space-y-8"></div>

        <section id="settlementArea" class="mt-8 pt-8">
            <div class="app-card p-6 space-y-6">
                <h3 class="serif text-2xl text-center font-bold">Settlement</h3>
                <div class="overflow-hidden rounded-2xl border border-gray-100 bg-white/50">
                    <table class="w-full text-left text-[11px]">
                        <thead class="bg-gray-50/50 font-bold opacity-50">
                            <tr>
                                <th class="p-3">NAME</th>
                                <th class="p-3 text-right">PAID(HK)</th>
                                <th class="p-3 text-right">PAID(<span class="target-curr-label">--</span>)</th>
                                <th class="p-3 text-right">NET</th>
                            </tr>
                        </thead>
                        <tbody id="calculationTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
                <div id="transferList" class="space-y-3"></div>
                <button onclick="copySummary()" class="btn-primary shadow-lg uppercase tracking-widest">Copy Report</button>
                <div class="flex flex-col gap-2 pt-2">
                    <button onclick="deleteCurrentTrip()" class="w-full text-[10px] opacity-40 font-bold">DELETE TRIP</button>
                    <button onclick="resetAllData()" class="w-full text-[10px] text-red-400 opacity-60 font-bold">RESET ALL DATA</button>
                </div>
            </div>
        </section>
        <div class="h-20"></div>
    </div>
  </main>

  <div id="modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-end">
    <div class="bg-[#f1ede4] w-full rounded-t-[40px] p-8 shadow-2xl max-h-[90vh] overflow-y-auto">
        <div class="w-12 h-1.5 bg-gray-300 mx-auto mb-8 rounded-full"></div>
        <h3 id="modalTitle" class="serif text-2xl mb-8 text-center font-bold">Record</h3>
        <input type="hidden" id="exDate">
        <div class="space-y-6">
            <div>
                <p class="text-[10px] font-bold opacity-40 mb-2 uppercase ml-2">Description</p>
                <input id="exDesc" type="text" placeholder="What's this for?">
            </div>
            <div class="flex gap-4">
                <div class="flex-1">
                    <p class="text-[10px] font-bold opacity-40 mb-2 uppercase ml-2">Amount</p>
                    <input id="exAmt" type="number" inputmode="decimal" placeholder="0.00">
                </div>
                <div class="w-32">
                    <p class="text-[10px] font-bold opacity-40 mb-2 uppercase ml-2">Currency</p>
                    <select id="exCurr"></select>
                </div>
            </div>
            <div id="payerSection" class="space-y-6">
                <div class="flex items-center gap-4 p-5 bg-white/50 rounded-3xl">
                    <input type="checkbox" id="usePool" onchange="togglePoolPayer(this.checked)">
                    <label for="usePool" class="text-sm font-bold">Paid by Common Pool?</label>
                </div>
                <div id="personalPayerFields" class="space-y-6">
                    <div>
                        <p class="text-[10px] font-bold opacity-40 mb-2 uppercase ml-2">Payer</p>
                        <select id="exPayer"></select>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold opacity-40 mb-2 uppercase ml-2">Splitees</p>
                        <div id="modalSplit" class="grid grid-cols-2 gap-3 bg-white/50 rounded-3xl p-4"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex gap-4 mt-10 pb-4">
            <button onclick="closeModal()" class="flex-1 py-4 text-sm font-bold opacity-40">Close</button>
            <button onclick="saveRecord()" class="flex-1 btn-primary">SAVE</button>
        </div>
    </div>
  </div>

<script>
  let trips = JSON.parse(localStorage.getItem('tripLedger_all') || '[{"id":1,"name":"New Trip"}]');
  let currentTripId = parseInt(localStorage.getItem('tripLedger_currentId') || '1');
  let state = {};

  function init() {
    let currentTrip = trips.find(t => t.id === currentTripId) || trips[0];
    currentTripId = currentTrip.id;
    state = { tripName: 'New Trip', members: [], expenses: [], poolDeposits: [], targetCurr: 'JPY', rateVal: 19.3, ...currentTrip };
    renderTabs(); syncUI();
  }

  function renderTabs() {
    const container = document.getElementById('tabContainer');
    container.innerHTML = trips.map(t => {
      const displayTitle = (t.id === currentTripId) ? (state.tripName || 'Untitled') : (t.name || 'Untitled');
      return `<div onclick="switchTrip(${t.id})" class="trip-tab ${t.id === currentTripId ? 'active' : ''}">${displayTitle}</div>`;
    }).join('');
    localStorage.setItem('tripLedger_currentId', currentTripId);
  }

  function switchTrip(id) { saveAll(); currentTripId = id; init(); }
  function addNewTrip() { saveAll(); const newId = Date.now(); trips.push({ id: newId, name: 'New Trip', members: [], expenses: [], poolDeposits: [], targetCurr: 'JPY', rateVal: 19.3 }); currentTripId = newId; init(); }
  function deleteCurrentTrip() { if (trips.length <= 1) return; if (confirm("Delete this trip?")) { trips = trips.filter(t => t.id !== currentTripId); currentTripId = trips[0].id; localStorage.setItem('tripLedger_all', JSON.stringify(trips)); init(); } }

  // æ–°å¢ž Reset åŠŸèƒ½
  function resetAllData() {
    if (confirm("ðŸš¨ WARNING: This will permanently delete ALL trips and settings. Are you sure?")) {
      localStorage.clear();
      window.location.reload();
    }
  }

  function saveAll() {
    state.tripName = document.getElementById('tripName').value;
    state.startDate = document.getElementById('startDate').value;
    state.endDate = document.getElementById('endDate').value;
    state.targetCurr = document.getElementById('targetCurr').value;
    state.rateVal = parseFloat(document.getElementById('currentRateVal').value) || 1;
    const idx = trips.findIndex(t => t.id === currentTripId);
    if (idx !== -1) trips[idx] = { ...state };
    localStorage.setItem('tripLedger_all', JSON.stringify(trips));
    renderTabs();
    syncUI();
  }

  async function handleCurrChange() { state.targetCurr = document.getElementById('targetCurr').value; await fetchLiveRate(); }
  async function fetchLiveRate() {
    try {
        const res = await fetch(`https://open.er-api.com/v6/latest/HKD`);
        const data = await res.json();
        if (data && data.rates[state.targetCurr]) {
            state.rateVal = parseFloat(data.rates[state.targetCurr].toFixed(4));
            document.getElementById('currentRateVal').value = state.rateVal;
            saveAll(); syncUI();
        }
    } catch (e) { console.error(e); }
  }

  function toHKD(amt, curr) { return curr === 'HKD' ? amt : amt / state.rateVal; }

  function syncUI() {
    document.getElementById('tripName').value = state.tripName;
    document.getElementById('startDate').value = state.startDate || '';
    document.getElementById('endDate').value = state.endDate || '';
    document.getElementById('targetCurr').value = state.targetCurr;
    document.getElementById('currentRateVal').value = state.rateVal;
    document.querySelectorAll('.target-curr-label').forEach(el => el.innerText = state.targetCurr);
    document.getElementById('exCurr').innerHTML = `<option value="HKD">HKD</option><option value="${state.targetCurr}">${state.targetCurr}</option>`;
    document.getElementById('memberList').innerHTML = (state.members || []).map(m => `<div class="bg-white px-4 py-2 rounded-full text-[11px] font-bold shadow-sm flex items-center gap-2">${m}<button onclick="removeMember('${m}')" class="text-red-300">Ã—</button></div>`).join('');
    renderTimeline(); calculateFinancials();
  }

  function renderTimeline() {
    const exps = state.expenses || [];
    const preExps = exps.filter(e => e.date === 'PRE');
    document.getElementById('preTripContainer').innerHTML = preExps.map(e => itemHtml(e)).join('') || '<p class="text-center py-2 text-[11px] opacity-30 italic">No records</p>';
    let h = '';
    const start = new Date(state.startDate); const end = new Date(state.endDate);
    if (state.startDate && state.endDate && start <= end) {
        let d = new Date(start); let dayCount = 1;
        while (d <= end) {
            const ds = d.toISOString().split('T')[0];
            const displayDate = ds.replace(/-/g, '/');
            const dayExps = exps.filter(e => e.date === ds);
            h += `<div class="mb-8"><div class="flex justify-between items-end mb-4 px-2"><p class="serif text-2xl font-bold">Day ${dayCount}</p><p class="text-[10px] opacity-40 font-bold tracking-widest uppercase">${displayDate}</p></div><div class="space-y-4">${dayExps.map(e => itemHtml(e)).join('')}</div><button onclick="openModal('${ds}')" class="mt-4 text-[11px] font-bold opacity-60 w-full py-4 rounded-[20px] bg-white/60 border border-white/40">+ ADD RECORD</button></div>`;
            d.setDate(d.getDate() + 1); dayCount++;
        }
    }
    document.getElementById('timelineContainer').innerHTML = h;
  }
  
  function itemHtml(e) {
    return `<div class="app-card p-5 flex justify-between items-center ${e.settled?'settled':''}">
        <div class="flex items-center gap-4">
            <input type="checkbox" ${e.settled?'checked':''} onchange="toggleSettled('${e.id}')">
            <div>
                <p class="font-bold text-sm">${e.desc}</p>
                <p class="text-[10px] opacity-60 font-bold uppercase tracking-tight">${e.isPool?'ðŸŸ¡ Pool':e.payer} â€¢ ${e.curr} ${e.amt}</p>
            </div>
        </div>
        <button onclick="deleteExp('${e.id}')" class="text-gray-300 px-2 text-xl">Ã—</button></div>`;
  }

  function calculateFinancials() {
    const members = state.members || [];
    const calc = {}; members.forEach(m => calc[m] = { paidHKD: 0, paidTarget: 0, costHKD: 0 });
    let poolBalance = 0;
    (state.poolDeposits || []).forEach(d => { poolBalance += (d.curr === 'HKD' ? d.amt * state.rateVal : d.amt); });
    (state.expenses || []).filter(e => !e.settled).forEach(e => {
        const amtHKD = toHKD(e.amt, e.curr);
        const amtTarget = (e.curr === 'HKD' ? e.amt * state.rateVal : e.amt);
        if (e.isPool) { poolBalance -= amtTarget; }
        else {
            if (e.curr === 'HKD') calc[e.payer].paidHKD += e.amt;
            else if (e.curr === state.targetCurr) calc[e.payer].paidTarget += e.amt;
            const shareHKD = amtHKD / (e.splitWith.length || 1);
            e.splitWith.forEach(m => { if(calc[m]) calc[m].costHKD += shareHKD; });
        }
    });
    document.getElementById('commonPoolInfo').innerText = Math.round(poolBalance).toLocaleString();
    document.getElementById('depositList').innerHTML = (state.poolDeposits || []).map(d => `<div class="text-[9px] bg-white/40 p-2 rounded-xl flex justify-between"><span>+ ${d.curr} ${d.amt}</span><button onclick="deleteDeposit(${d.id})" class="text-red-300 px-2">Ã—</button></div>`).join('');
    
    document.getElementById('calculationTable').innerHTML = members.map(m => {
        const totalPaidInHKD = calc[m].paidHKD + (calc[m].paidTarget / state.rateVal);
        const netHKD = totalPaidInHKD - calc[m].costHKD;
        return `<tr><td class="p-4 font-bold">${m}</td><td class="p-4 text-right opacity-60">${calc[m].paidHKD.toFixed(0)}</td><td class="p-4 text-right opacity-60">${calc[m].paidTarget.toFixed(0)}</td><td class="p-4 text-right font-bold ${netHKD>=0?'text-green-700':'text-red-700'}">${netHKD>0?'+':''}${netHKD.toFixed(0)}</td></tr>`;
    }).join('');
    
    let netA = members.map(m => ({ 
        name: m, 
        bal: (calc[m].paidHKD + (calc[m].paidTarget / state.rateVal)) - calc[m].costHKD 
    }));
    let creditors = netA.filter(x => x.bal > 0.5).sort((a,b) => b.bal - a.bal);
    let debtors = netA.filter(x => x.bal < -0.5).sort((a,b) => a.bal - b.bal);
    let tHtml = '';
    while(debtors.length && creditors.length) {
        let amt = Math.min(Math.abs(debtors[0].bal), creditors[0].bal);
        tHtml += `<div class="p-4 bg-white rounded-[20px] flex justify-between items-center shadow-sm text-xs"><span><b>${debtors[0].name}</b> âž” <b>${creditors[0].name}</b></span><span class="font-bold text-red-700">HKD ${Math.round(amt)}</span></div>`;
        debtors[0].bal += amt; creditors[0].bal -= amt;
        if (Math.abs(debtors[0].bal) < 0.5) debtors.shift();
        if (creditors[0].bal < 0.5) creditors.shift();
    }
    document.getElementById('transferList').innerHTML = tHtml || '<p class="text-center py-4 opacity-20 italic">Settled</p>';
  }

  function openModal(date) {
    const isDep = (date === 'DEPOSIT');
    document.getElementById('modalTitle').innerText = isDep ? 'Deposit Pool' : 'New Record';
    document.getElementById('exDate').value = date || 'PRE';
    document.getElementById('exDesc').parentElement.classList.toggle('hidden', isDep);
    document.getElementById('payerSection').classList.toggle('hidden', isDep);
    document.getElementById('modal').classList.remove('hidden');
    togglePoolPayer(false);
  }
  function openDepositModal() { openModal('DEPOSIT'); }
  function closeModal() { document.getElementById('modal').classList.add('hidden'); }
  function togglePoolPayer(isPool) {
    document.getElementById('personalPayerFields').style.display = isPool ? 'none' : 'grid';
    document.getElementById('exPayer').innerHTML = (state.members || []).map(m => `<option value="${m}">${m}</option>`).join('');
    document.getElementById('modalSplit').innerHTML = (state.members || []).map(m => `<label class="flex items-center gap-2 p-2 bg-white rounded-xl"><input type="checkbox" value="${m}" checked> <span class="text-xs font-bold">${m}</span></label>`).join('');
  }
  function saveRecord() {
    const amt = parseFloat(document.getElementById('exAmt').value);
    const curr = document.getElementById('exCurr').value;
    const selectedDate = document.getElementById('exDate').value;
    if (!amt) return;
    if (selectedDate === 'DEPOSIT') { state.poolDeposits.push({ id: Date.now(), amt, curr }); }
    else {
        const split = Array.from(document.querySelectorAll('#modalSplit input:checked')).map(i => i.value);
        state.expenses.push({ id: Date.now(), date: selectedDate, desc: document.getElementById('exDesc').value || 'Expense', amt, curr, payer: document.getElementById('exPayer').value, splitWith: split, isPool: document.getElementById('usePool').checked });
    }
    closeModal(); saveAll(); syncUI();
    document.getElementById('exAmt').value = ''; document.getElementById('exDesc').value = '';
  }
  function addMember() { const n = prompt("Name?"); if(n) { state.members.push(n); saveAll(); syncUI(); } }
  function removeMember(n) { if(confirm(`Remove ${n}?`)) { state.members = state.members.filter(m => m !== n); saveAll(); syncUI(); } }
  function deleteExp(id) { state.expenses = state.expenses.filter(e => e.id != id); saveAll(); syncUI(); }
  function deleteDeposit(id) { state.poolDeposits = state.poolDeposits.filter(d => d.id != id); saveAll(); syncUI(); }
  function toggleSettled(id) { const e = state.expenses.find(x => x.id == id); if(e) e.settled = !e.settled; saveAll(); syncUI(); }
  function copySummary() { navigator.clipboard.writeText(document.getElementById('transferList').innerText); alert("Copied!"); }

  init();
</script>
</body>
</html>
